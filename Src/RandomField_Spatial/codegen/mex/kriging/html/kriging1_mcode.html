<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">zi</span>,<span class="var type1" id="S3T1U4">s2zi</span>] = kriging(<span class="var type1" id="S4T2U7">vstruct</span>,<span class="var type1" id="S5T1U8">x</span>,<span class="var type1" id="S6T1U9">y</span>,<span class="var type1" id="S7T1U10">z</span>,<span class="var type1" id="S8T1U11">xi</span>,<span class="var type1" id="S9T1U12">yi</span>,<span class="var type1" id="S10T1U13">chunksize</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% interpolation with ordinary kriging in two dimensions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% Syntax:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%     [zi,zivar] = kriging(vstruct,x,y,z,xi,yi)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%     [zi,zivar] = kriging(vstruct,x,y,z,xi,yi,chunksize)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% Description:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%     kriging uses ordinary kriging to interpolate a variable z measured at</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">%     locations with the coordinates x and y at unsampled locations xi, yi.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%     The function requires the variable vstruct that contains all</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">%     necessary information on the variogram. vstruct is the forth output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">%     argument of the function variogramfit.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%     This is a rudimentary, but easy to use function to perform a simple</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%     kriging interpolation. I call it rudimentary since it always includes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">%     ALL observations to estimate values at unsampled locations. This may</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%     not be necessary when sample locations are not within the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%     autocorrelation range but would require something like a k nearest</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%     neighbor search algorithm or something similar. Thus, the algorithms</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%     works best for relatively small numbers of observations (100-500).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">%     For larger numbers of observations I recommend the use of GSTAT.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%     Note that kriging fails if there are two or more observations at one</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%     location or very, very close to each other. This may cause that the </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">%     system of equation is badly conditioned. Currently, I use the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">%     pseudo-inverse (pinv) to come around this problem. If you have better</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">%     ideas, please let me know.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">% Input arguments:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%     vstruct   structure array with variogram information as returned</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">%               variogramfit (forth output argument)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%     x,y       coordinates of observations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%     z         values of observations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%     xi,yi     coordinates of locations for predictions </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">%     chunksize nr of elements in zi that are processed at one time.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">%               The default is 100, but this depends largely on your </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">%               available main memory and numel(x).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">% Output arguments:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">%     zi        kriging predictions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%     zivar     kriging variance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% Example:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%     % create random field with autocorrelation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">%     [X,Y] = meshgrid(0:500);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">%     Z = randn(size(X));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">%     Z = imfilter(Z,fspecial('gaussian',[40 40],8));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%     % sample the field</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">%     n = 500;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%     x = rand(n,1)*500;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">%     y = rand(n,1)*500;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">%     z = interp2(X,Y,Z,x,y);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">%     % plot the random field</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">%     subplot(2,2,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">%     imagesc(X(1,:),Y(:,1),Z); axis image; axis xy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">%     hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%     plot(x,y,'.k')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="comment">%     title('random field with sampling locations')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="comment">%     % calculate the sample variogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%     v = variogram([x y],z,'plotit',false,'maxdist',100);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">%     % and fit a spherical variogram</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">%     subplot(2,2,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="comment">%     [dum,dum,dum,vstruct] = variogramfit(v.distance,v.val,[],[],[],'model','stable');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">%     title('variogram')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%     % now use the sampled locations in a kriging</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%     [Zhat,Zvar] = kriging(vstruct,x,y,z,X,Y);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%     subplot(2,2,3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="comment">%     imagesc(X(1,:),Y(:,1),Zhat); axis image; axis xy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">%     title('kriging predictions')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%     subplot(2,2,4)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%     contour(X,Y,Zvar); axis image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%     title('kriging variance')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">% see also: variogram, variogramfit, consolidator, pinv</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="comment">% Date: 13. October, 2010</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="comment">% Author: Wolfgang Schwanghart (w.schwanghart[at]unibas.ch)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">% size of input arguments</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="mxinfo " id="T4:U10"><span class="var type1" id="S11T4U16">sizest</span> = <span class="mxinfo " id="T4:U12">size(<span class="var type1" id="S8T1U19">xi</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="mxinfo " id="T1:U14"><span class="var type1" id="S13T1U22">numest</span> = <span class="mxinfo " id="T1:U16">numel(<span class="var type1" id="S8T1U25">xi</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="mxinfo " id="T1:U18"><span class="var type1" id="S15T1U28">numobs</span> = <span class="mxinfo " id="T1:U20">numel(<span class="var type1" id="S5T1U31">x</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="comment">% force column vectors</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="mxinfo " id="T1:U22"><span class="var type1" id="S8T1U34">xi</span> = <span class="var type1" id="S8T1U36">xi</span>(:)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="mxinfo " id="T1:U25"><span class="var type1" id="S9T1U40">yi</span> = <span class="var type1" id="S9T1U42">yi</span>(:)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T1:U28"><span class="var type1" id="S5T1U46">x</span>  = <span class="var type1" id="S5T1U48">x</span>(:)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="mxinfo " id="T1:U31"><span class="var type1" id="S6T1U52">y</span>  = <span class="var type1" id="S6T1U54">y</span>(:)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="mxinfo " id="T1:U34"><span class="var type1" id="S7T1U58">z</span>  = <span class="var type1" id="S7T1U60">z</span>(:)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="keyword">if</span> nargin == 6;</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">    <span class="var type0" id="S10T0U70">chunksize</span> = 100;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="keyword">elseif</span> nargin == 7;</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    error(<span class="string">'wrong number of input arguments'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">% check if the latest version of variogramfit is used</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="keyword">if</span> ~isfield(<span class="var type1" id="S4T2U87">vstruct</span>, <span class="string">'func'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">    error(<span class="string">'please download the latest version of variogramfit from the FEX'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="comment">% variogram function definitions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="keyword">switch</span> lower(<span class="mxinfo " id="T2:U38"><span class="var type1" id="S4T2U97"><span class="message error" id="M1F1C">vstruct</span></span></span>.model)    </span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    <span class="keyword">case</span> {<span class="string">'whittle'</span> <span class="string">'matern'</span>}</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">        error(<span class="string">'whittle and matern are not supported yet'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'stable'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">        <span class="var type0" id="S20T0U112">stablealpha</span> = <span class="mxinfo " id="T2:U39"><span class="var type1" id="S4T2U114"><span class="message error" id="M2F1C">vstruct</span></span></span>.stablealpha; <span class="comment">%#ok&lt;NASGU&gt; % will be used in an anonymous function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="comment">% distance matrix of locations with known values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="mxinfo " id="T1:U40"><span class="var type1" id="S21T1U118">Dx</span> = <span class="mxinfo " id="T1:U42">hypot(<span class="mxinfo " id="T1:U43">bsxfun(<span class="mxinfo " id="T5:U44"><span class="message warning" id="M3F1C">@minus</span></span>,<span class="var type1" id="S5T1U125">x</span>,<span class="var type1" id="S5T1U127">x</span>')</span>,<span class="mxinfo " id="T1:U47">bsxfun(<span class="mxinfo " id="T7:U48"><span class="message warning" id="M4F1C">@minus</span></span>,<span class="var type1" id="S6T1U132">y</span>,<span class="var type1" id="S6T1U134">y</span>')</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="comment">% if we have a bounded variogram model, it is convenient to set distances</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="comment">% that are longer than the range to the range since from here on the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="comment">% variogram value remains the same and we don need composite functions.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="keyword">switch</span> <span class="mxinfo " id="T2:U51"><span class="var type1" id="S4T2U137"><span class="message error" id="M5F1C">vstruct</span></span></span>.type;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    <span class="keyword">case</span> <span class="string">'bounded'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">        <span class="var type0" id="S21T0U143">Dx</span> = min(<span class="var type1" id="S21T1U146">Dx</span>,<span class="mxinfo " id="T2:U53"><span class="var type1" id="S4T2U148"><span class="message error" id="M6F1C">vstruct</span></span></span>.range);</span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="keyword">otherwise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"><span class="comment">% now calculate the matrix with variogram values </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"><span class="var type0" id="S26T0U153">A</span> = <span class="mxinfo " id="T2:U54"><span class="var type1" id="S4T2U156"><span class="message error" id="M7F1C">vstruct</span></span></span>.func([<span class="var type0" id="S4T0U161">vstruct</span>.range <span class="var type0" id="S4T0U164">vstruct</span>.sill],<span class="var type0" id="S21T0U166">Dx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"><span class="keyword">if</span> ~isempty(<span class="mxinfo " id="T2:U55"><span class="var type1" id="S4T2U173"><span class="message error" id="M8F1C">vstruct</span></span></span>.nugget)</span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="var type0" id="S26T0U177">A</span> = <span class="var type0" id="S26T0U179"><span class="message error" id="M9F1C">A</span></span>+<span class="var type0" id="S4T0U181">vstruct</span>.nugget;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line"><span class="comment">% the matrix must be expanded by one line and one row to account for</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line"><span class="comment">% condition, that all weights must sum to one (lagrange multiplier)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"><span class="var type0" id="S26T0U185">A</span> = [[<span class="var type0" id="S26T0U190"><span class="message error" id="M10F1C">A</span></span> ones(<span class="var type0" id="S15T0U193">numobs</span>,1)];ones(1,<span class="var type0" id="S15T0U199">numobs</span>) 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="comment">% A is often very badly conditioned. Hence we use the Pseudo-Inverse for</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="comment">% solving the equations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="var type0" id="S26T0U203">A</span> = pinv(<span class="var type0" id="S26T0U206"><span class="message error" id="M11F1C">A</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="comment">% we also need to expand z</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="mxinfo " id="T8:U56"><span class="var type1" id="S7T8U209">z</span>  = <span class="mxinfo " id="T8:U58">[<span class="var type1" id="S7T1U212">z</span>;<span class="mxinfo " id="T1:U60">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">% allocate the output zi</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="mxinfo " id="T1:U61"><span class="var type1" id="S2T1U217">zi</span> = <span class="mxinfo " id="T1:U63">nan(<span class="var type1" id="S13T1U220">numest</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line"><span class="keyword">if</span> nargout == 2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo " id="T1:U65"><span class="var type1" id="S3T1U230">s2zi</span> = <span class="mxinfo " id="T1:U67">nan(<span class="var type1" id="S13T1U233">numest</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">    <span class="mxinfo " id="T6:U69"><span class="var type1" id="S32T6U237">krigvariance</span> = <span class="mxinfo " id="T6:U71">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="var type0" id="S32T0U243">krigvariance</span> = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="comment">% parametrize engine</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"><span class="mxinfo " id="T1:U72"><span class="var type1" id="S35T1U248">nrloops</span>   = <span class="mxinfo " id="T1:U74">ceil(<span class="mxinfo " id="T1:U75"><span class="var type1" id="S13T1U252">numest</span>/<span class="var type1" id="S10T1U253">chunksize</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="comment">% initialize the waitbar</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="var type0" id="S37T0U256">h</span>  = <span class="message error" id="M12F1C">waitbar(<span class="mxinfo " id="T1:U78">0</span>,<span class="mxinfo " id="T9:U79"><span class="string">'Kr<span class="keyword">...</span>kr...kriging'</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">% now loop </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S39T1U263">r</span> = <span class="mxinfo " id="T1:U81"><span class="mxinfo " id="T1:U82">1</span>:<span class="var type1" id="S35T1U266">nrloops</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">    <span class="comment">% waitbar </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    waitbar(<span class="mxinfo " id="T1:U84"><span class="var type1" id="S39T1U271">r</span> / <span class="var type1" id="S35T1U272">nrloops</span></span>,<span class="var type0" id="S37T0U273"><span class="message error" id="M13F1C">h</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">    <span class="comment">% built chunks</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T6:U87"><span class="var type1" id="S39T1U277">r</span>&lt;<span class="var type1" id="S35T1U278">nrloops</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">        <span class="mxinfo " id="T10:U90"><span class="var type1" id="S40T10U281">IX</span> = <span class="mxinfo " id="T10:U92"><span class="message warning" id="M14F1C"><span class="mxinfo " id="T1:U93"><span class="mxinfo " id="T1:U94">(<span class="mxinfo " id="T1:U95"><span class="var type1" id="S39T1U287">r</span>-1</span>)*<span class="var type1" id="S10T1U289">chunksize</span></span> +1</span> : <span class="mxinfo " id="T1:U98"><span class="var type1" id="S39T1U292">r</span>*<span class="var type1" id="S10T1U293">chunksize</span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">        <span class="mxinfo " id="T10:U101"><span class="var type1" id="S40T10U297">IX</span> = <span class="mxinfo " id="T10:U103"><span class="message warning" id="M15F1C"><span class="mxinfo " id="T1:U104"><span class="mxinfo " id="T1:U105">(<span class="mxinfo " id="T1:U106"><span class="var type1" id="S39T1U303">r</span>-1</span>)*<span class="var type1" id="S10T1U305">chunksize</span></span> +1</span> : <span class="var type1" id="S13T1U307">numest</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">        <span class="mxinfo " id="T1:U110"><span class="var type1" id="S10T1U310">chunksize</span> = <span class="mxinfo " id="T1:U112">numel(<span class="var type1" id="S40T10U313">IX</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    <span class="comment">% build b</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">    <span class="mxinfo " id="T11:U114"><span class="var type1" id="S41T11U316">b</span> = <span class="mxinfo " id="T11:U116">hypot(<span class="mxinfo " id="T11:U117">bsxfun(<span class="mxinfo " id="T12:U118"><span class="message warning" id="M16F1C">@minus</span></span>,<span class="var type1" id="S5T1U323">x</span>,<span class="mxinfo " id="T11:U120"><span class="mxinfo " id="T10:U121"><span class="var type1" id="S8T1U326">xi</span>(<span class="var type1" id="S40T10U327">IX</span>)</span>'</span>)</span>,<span class="mxinfo " id="T11:U124">bsxfun(<span class="mxinfo " id="T13:U125"><span class="message warning" id="M17F1C">@minus</span></span>,<span class="var type1" id="S6T1U332">y</span>,<span class="mxinfo " id="T11:U127"><span class="mxinfo " id="T10:U128"><span class="var type1" id="S9T1U335">yi</span>(<span class="var type1" id="S40T10U336">IX</span>)</span>'</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="comment">% again set maximum distances to the range</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    <span class="keyword">switch</span> <span class="mxinfo " id="T2:U131"><span class="var type1" id="S4T2U339"><span class="message error" id="M18F1C">vstruct</span></span></span>.type</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">        <span class="keyword">case</span> <span class="string">'bounded'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">            <span class="var type0" id="S41T0U345">b</span> = min(<span class="mxinfo " id="T2:U132"><span class="var type1" id="S4T2U349"><span class="message error" id="M19F1C">vstruct</span></span></span>.range,<span class="var type0" id="S41T0U351">b</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">    <span class="comment">% expand b with ones</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">    <span class="var type0" id="S41T0U354">b</span> = [<span class="mxinfo " id="T2:U133"><span class="var type1" id="S4T2U359"><span class="message error" id="M20F1C">vstruct</span></span></span>.func([<span class="var type0" id="S4T0U364">vstruct</span>.range <span class="var type0" id="S4T0U367">vstruct</span>.sill],<span class="var type0" id="S41T0U369">b</span>);ones(1,<span class="var type0" id="S10T0U374">chunksize</span>)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">    <span class="keyword">if</span> ~isempty(<span class="mxinfo " id="T2:U134"><span class="var type1" id="S4T2U381"><span class="message error" id="M21F1C">vstruct</span></span></span>.nugget)</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">        <span class="var type0" id="S41T0U385">b</span> = <span class="var type0" id="S41T0U387"><span class="message error" id="M22F1C">b</span></span>+<span class="var type0" id="S4T0U389">vstruct</span>.nugget;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">    <span class="comment">% solve system</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">    <span class="var type0" id="S42T0U393">lambda</span> = <span class="var type0" id="S26T0U395"><span class="message error" id="M23F1C">A</span></span>*<span class="var type0" id="S41T0U396">b</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">    <span class="comment">% estimate zi</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">    <span class="var type0" id="S2T0U400">zi</span>(<span class="var type0" id="S40T0U401">IX</span>)  = <span class="var type0" id="S42T0U404"><span class="message error" id="M24F1C">lambda</span></span>'*<span class="var type0" id="S7T0U405">z</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">    <span class="comment">% calculate kriging variance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S32T6U408">krigvariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">        <span class="var type0" id="S3T0U412">s2zi</span>(<span class="var type0" id="S40T0U413">IX</span>) = sum(<span class="var type0" id="S41T0U417"><span class="message error" id="M25F1C">b</span></span>.*<span class="var type0" id="S42T0U418">lambda</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"><span class="comment">% close waitbar</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line">close(<span class="var type0" id="S37T0U423"><span class="message error" id="M26F1C">h</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"><span class="comment">% reshape zi</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line"><span class="mxinfo " id="T1:U136"><span class="var type1" id="S2T1U426">zi</span> = <span class="mxinfo " id="T1:U138">reshape(<span class="var type1" id="S2T1U429">zi</span>,<span class="var type1" id="S11T4U430">sizest</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S32T6U433">krigvariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line">    <span class="mxinfo " id="T1:U142"><span class="var type1" id="S3T1U436">s2zi</span> = <span class="mxinfo " id="T1:U144">reshape(<span class="var type1" id="S3T1U439">s2zi</span>,<span class="var type1" id="S11T4U440">sizest</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
</pre>
